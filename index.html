<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Seans Planlayıcı</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <!-- Giriş ekranı (token yoksa gösterilir) -->
    <div id="loginOverlay" class="login-overlay hidden" aria-hidden="true">
      <div class="login-card">
        <h1 class="login-title">Seans Planlayıcı</h1>
        <p class="login-hint">Backend'e bağlanmak için giriş yapın.</p>
        <form id="loginForm" class="login-form">
          <div class="formRow">
            <label class="label" for="loginUsername">Kullanıcı adı</label>
            <input id="loginUsername" class="input" type="text" autocomplete="username" required />
          </div>
          <div class="formRow">
            <label class="label" for="loginPassword">Şifre</label>
            <input id="loginPassword" class="input" type="password" autocomplete="current-password" required />
          </div>
          <p id="loginError" class="error hidden"></p>
          <button id="loginBtn" class="btn btn--primary" type="submit">Giriş</button>
        </form>
        <p class="login-footer">İlk kurulumda: <code>admin</code> / <code>admin123</code> (seed sonrası)</p>
      </div>
    </div>

    <div class="app" id="mainApp">
      <header class="topbar">
        <div class="topbar__left">
          <div class="brand">Seans Planlayıcı</div>
          <div class="weeknav">
            <div style="display:flex; gap:8px; align-items:center; margin-right:12px;">
              <button id="viewWeekBtn" class="btn btn--ghost" type="button" data-view="week">Haftalık</button>
              <button id="viewDayBtn" class="btn btn--ghost" type="button" data-view="day">Günlük</button>
            </div>
            <input id="plannerFilterInput" class="input" type="text" placeholder="Üye veya personel ismi ile filtrele..." title="Üye veya personel adı yazın. Haftalık: hangi günlerde, Günlük: hangi saatte gösterilir." style="width:200px; min-width:160px;" />
            <button id="prevBtn" class="btn btn--ghost" type="button">◀</button>
            <div class="weeknav__label" id="weekLabel">-</div>
            <button id="nextBtn" class="btn btn--ghost" type="button">▶</button>
            <button id="todayBtn" class="btn btn--ghost" type="button">Bugün</button>
          </div>
        </div>
        <div class="topbar__right">
          <button id="addSessionBtn" class="btn btn--primary" type="button">Seans Ekle</button>
          <button id="taskDistributionBtn" class="btn btn--ghost" type="button" title="Tüm odalar dolu iken (oda sayısı kadar personel) görev dağıtımı">
            Görev Dağıtımı
          </button>
          <button id="printBtn" class="btn btn--ghost" type="button" title="Haftalık programı yazdır">
            Yazdır
          </button>
          <div class="export-dropdown-wrap" style="position:relative; display:inline-block;">
            <button id="exportBtn" class="btn btn--ghost" type="button" aria-haspopup="true" aria-expanded="false">Dışa Aktar ▾</button>
            <div id="exportDropdown" class="export-dropdown hidden" role="menu">
              <button type="button" role="menuitem" id="exportSessionsExcelBtn">Seanslar → Excel (.xlsx)</button>
              <button type="button" role="menuitem" id="exportSessionsPdfBtn">Seanslar → PDF</button>
              <button type="button" role="menuitem" id="exportJsonBtn">Tüm veri (JSON)</button>
            </div>
          </div>
          <label class="btn btn--ghost fileBtn" for="importFile">
            İçe Aktar
            <input id="importFile" type="file" accept="application/json" />
          </label>
        </div>
      </header>

      <button class="sidebar__open-tab hidden" id="sidebarOpenBtn" type="button" title="Sidebar'ı aç" aria-label="Sidebar'ı aç">☰</button>
      <main class="content" id="mainContent">
        <aside class="sidebar" id="sidebar">
          <div class="sidebar__inner">
          <section class="panel">
            <div class="panel__title">Ayarlar</div>
            <div class="formRow">
              <button id="openWorkingHoursBtn" class="btn btn--ghost" type="button" style="width:100%;">
                Çalışma Saatleri
              </button>
            </div>
            <div class="formRow" style="margin-top:12px;">
              <button id="openRoomsBtn" class="btn btn--ghost" type="button" style="width:100%;">
                Odalar / Alet
              </button>
            </div>
            <div class="formRow" style="margin-top:12px;">
              <button id="openPackagesBtn" class="btn btn--ghost" type="button" style="width:100%;">
                Paket Tanımlama
              </button>
            </div>
            <div class="formRow" style="margin-top:12px;">
              <button id="openStaffBtn" class="btn btn--ghost" type="button" style="width:100%;">
                Personel
              </button>
            </div>
            <div class="formRow" style="margin-top:12px;">
              <button id="openActivityLogsBtn" class="btn btn--ghost" type="button" style="width:100%;" title="Kim, ne, ne zaman – işlem geçmişi">
                İşlem Logları
              </button>
            </div>
          </section>

          <section class="panel">
            <div class="panel__title">Üyeler</div>
            <div id="membersList" class="list"></div>
            <button id="addMemberBtn" class="btn btn--ghost" type="button" style="width:100%; margin-top:8px;">+ Üye Ekle</button>
            <button id="openListMembersBtn" class="btn btn--ghost" type="button" style="width:100%; margin-top:8px;" title="Aktif paketi olan üyeler">Üyeleri Listele</button>
            <button id="openExpiredMembershipsBtn" class="btn btn--ghost" type="button" style="width:100%; margin-top:8px;" title="Bitiş tarihi geçmiş paketler ve seansları">Üyeliği Bitmiş Üyeler</button>
          </section>

          <section class="panel">
            <div class="panel__title">Notlar</div>
            <div class="hint">
              Seans eklerken:
              <ul>
                <li>Personel aynı anda 2 seansa atanamaz.</li>
                <li>Oda kapasitesi (alet sayısı) aşılırsa engellenir.</li>
                <li>Oda seçimi <b>AUTO</b> ise uygun oda otomatik seçilir.</li>
              </ul>
            </div>
          </section>
          </div>
          <div class="sidebar__actions">
            <button class="sidebar__resize-btn" id="sidebarResizeBtn" type="button" title="Daralt / Genişlet">«</button>
            <button class="sidebar__toggle-btn" id="sidebarToggleBtn" type="button" title="Sidebar'ı kapat">◀</button>
          </div>
        </aside>

        <section class="planner">
          <div class="planner__header" id="plannerHeader"></div>
          <div class="planner__gridWrap">
            <div class="planner__grid" id="plannerGrid"></div>
          </div>
        </section>
      </main>
    </div>

    <!-- Modal: Grup Seans (Ekle / Düzenle) -->
    <div class="modal hidden" id="groupSessionModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="groupSessionModal"></div>
      <div class="modal__card" style="max-width:600px;">
        <div class="modal__title" id="groupSessionModalTitle">Grup Seans Ekle</div>
        <div class="modal__body">
          <!-- Yeni grup eklerken: Tarih, Saat, Personel, Oda seçilir -->
          <div id="groupSessionCreateFields" class="hidden">
            <div class="formRow">
              <label class="label">Tarih</label>
              <input id="groupSessionNewDate" class="input" type="date" />
            </div>
            <div class="formRow">
              <label class="label">Saat</label>
              <input id="groupSessionNewTime" class="input" type="time" />
            </div>
            <div class="formRow">
              <label class="label">Personel</label>
              <select id="groupSessionNewStaff" class="input"></select>
            </div>
            <div class="formRow">
              <label class="label">Oda</label>
              <select id="groupSessionNewRoom" class="input"></select>
            </div>
          </div>
          <!-- Mevcut grup düzenlerken: Tarih/Saat/Personel/Oda düzenlenebilir -->
          <div id="groupSessionDisplayFields">
            <div class="formRow">
              <label class="label">Tarih</label>
              <input id="groupSessionDate" class="input" type="date" />
            </div>
            <div class="formRow">
              <label class="label">Saat</label>
              <input id="groupSessionTime" class="input" type="time" />
            </div>
            <div class="formRow">
              <label class="label">Personel</label>
              <select id="groupSessionStaff" class="input"></select>
            </div>
            <div class="formRow">
              <label class="label">Oda</label>
              <select id="groupSessionRoom" class="input"></select>
            </div>
          </div>
          <div class="formRow formRow--full" style="margin-top:16px;">
            <label class="label">Üyeler</label>
            <div id="groupSessionMembers" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div>
            <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <select id="groupSessionNewMemberSelect" class="input" style="flex:1; min-width:180px;" aria-label="Eklenecek üye">
                <option value="">Üye seçin...</option>
              </select>
              <button id="groupSessionAddMemberBtn" class="btn btn--primary" type="button">
                <span style="margin-right:6px;">+</span> Üye Ekle
              </button>
            </div>
          </div>
          <div id="groupSessionError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="groupSessionModal">Vazgeç</button>
          <button id="saveGroupSessionBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Üye Kimlik Kartı -->
    <div class="modal hidden" id="memberCardModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="memberCardModal"></div>
      <div class="modal__card" style="max-width:520px;">
        <div class="modal__title" id="memberCardTitle">Üye Kimlik Kartı</div>
        <div class="modal__body" style="max-height:70vh; overflow-y:auto;">
          <div class="formGrid">
            <div class="formRow">
              <label class="label" for="mcMemberNo">Üye Numarası</label>
              <input id="mcMemberNo" class="input" readonly placeholder="Yeni kayıtta otomatik atanır (FP001, FP002...)" title="Sistem tarafından otomatik atanır" />
            </div>
            <div class="formRow">
              <label class="label" for="mcFirstName">* Ad</label>
              <input id="mcFirstName" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="mcLastName">* Soyad</label>
              <input id="mcLastName" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="mcPhone">* Telefon</label>
              <input id="mcPhone" class="input" type="tel" placeholder="(xxx)xxx-xx-xx" maxlength="14" inputmode="numeric" autocomplete="tel" />
            </div>
            <div class="formRow">
              <label class="label" for="mcBirthDate">Doğum Tarihi</label>
              <input id="mcBirthDate" class="input" type="date" />
            </div>
            <div class="formRow">
              <label class="label" for="mcProfession">Mesleği</label>
              <input id="mcProfession" class="input" />
            </div>
            <div class="formRow formRow--full">
              <label class="label" for="mcEmail">E-Posta</label>
              <input id="mcEmail" class="input" type="email" />
            </div>
            
            <div class="formRow formRow--full">
              <label class="label" for="mcAddress">Adresi</label>
              <input id="mcAddress" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="mcContactName">Yakını Adı Soyadı</label>
              <input id="mcContactName" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="mcContactPhone">Yakını Telefon</label>
              <input id="mcContactPhone" class="input" type="tel" placeholder="(xxx)xxx-xx-xx" maxlength="14" inputmode="numeric" autocomplete="tel" />
            </div>
            <div class="formRow formRow--full">
              <label class="label" for="mcSystemicDiseases">Sistematik Hastalıklar (Kalp, Tansiyon, Şeker vb.)</label>
              <textarea id="mcSystemicDiseases" class="input" rows="2"></textarea>
            </div>
            <div class="formRow formRow--full">
              <label class="label" for="mcClinicalConditions">Klinik Rahatsızlıklar (Fıtık, Kireçlenme vb.)</label>
              <textarea id="mcClinicalConditions" class="input" rows="2"></textarea>
            </div>
            <div class="formRow formRow--full">
              <label class="label" for="mcPastOperations">Varsa Geçirdiği Operasyonlar</label>
              <textarea id="mcPastOperations" class="input" rows="2"></textarea>
            </div>
          </div>
          <div id="memberCardError" class="error hidden" style="margin-top:12px;"></div>
        </div>
        <div class="modal__footer">
          <button id="memberPackageInfoBtn" class="btn btn--ghost" type="button" title="Aldığı paket bilgisi ve geçmişi">Aldığı Paket Bilgisi</button>
          <button id="deleteMemberCardBtn" class="btn btn--danger" type="button" style="display:none;">Sil</button>
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="memberCardModal">Vazgeç</button>
          <button id="saveMemberCardBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Üye Sil (admin şifresi + geçmiş silinsin mi?) -->
    <div class="modal hidden" id="deleteMemberModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="deleteMemberModal"></div>
      <div class="modal__card" style="max-width:420px;">
        <div class="modal__title">Üyeyi Sil</div>
        <div class="modal__body">
          <div id="deleteMemberStep1">
            <label class="label" for="deleteMemberPassword">Admin şifresi</label>
            <input id="deleteMemberPassword" type="password" class="input" placeholder="Şifre" autocomplete="current-password" />
          </div>
          <div id="deleteMemberStep2" class="hidden">
            <p class="hint">Üyenin geçmiş bilgileri (seanslar, paketler) tamamen silinsin mi?</p>
            <div style="display:flex; gap:12px; margin-top:12px;">
              <label class="label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="radio" name="deleteMemberHistory" id="deleteMemberHistoryNo" value="no" checked />
                Hayır – Sadece listeden kaldır (veritabanında silindi işaretlensin)
              </label>
            </div>
            <div style="display:flex; gap:12px; margin-top:8px;">
              <label class="label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="radio" name="deleteMemberHistory" id="deleteMemberHistoryYes" value="yes" />
                Evet – Tüm geçmiş bilgileri kalıcı silinsin
              </label>
            </div>
          </div>
          <div id="deleteMemberError" class="error hidden" style="margin-top:12px;"></div>
        </div>
        <div class="modal__footer">
          <button id="deleteMemberCancelBtn" class="btn btn--ghost" type="button" data-close="deleteMemberModal">Vazgeç</button>
          <button id="deleteMemberNextBtn" class="btn btn--primary" type="button">İleri</button>
          <button id="deleteMemberConfirmBtn" class="btn btn--danger hidden" type="button">Sil</button>
        </div>
      </div>
    </div>

    <!-- Modal: Aldığı Paket Bilgisi -->
    <div class="modal hidden" id="memberPackageModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="memberPackageModal"></div>
      <div class="modal__card" style="width:min(640px, calc(100vw - 24px)); max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal__title">Aldığı Paket Bilgisi</div>
        <div class="modal__body" style="overflow-y:auto; flex:1;">
          <div class="formGrid">
            <div class="formRow formRow--full">
              <label class="label" for="mpPackage">Paket</label>
              <select id="mpPackage" class="input"><option value="">Seçiniz</option></select>
              <span id="mpPackageFirstSessionHint" class="hint hidden" style="margin-top:4px;">İlk seans geçtiği için paket (seans sayısı) değiştirilemez.</span>
            </div>
            <div class="formRow">
              <label class="label" for="mpMemberNo">Üye No</label>
              <input id="mpMemberNo" class="input" readonly />
            </div>
            <div class="formRow">
              <label class="label" for="mpStartDate">Üyelik Başlangıç Tarihi</label>
              <input id="mpStartDate" class="input" type="date" placeholder="Tarih Seçiniz!" />
            </div>
            <div class="formRow">
              <label class="label" for="mpEndDate">Üyelik Bitiş Tarihi</label>
              <input id="mpEndDate" class="input" type="date" placeholder="Tarih Seçiniz!" />
            </div>
            <div class="formRow formRow--full">
              <label class="label">
                <input type="checkbox" id="mpSkipDayDistribution" /> Paket Gün Dağılımı Yapmak İstemiyorum
              </label>
            </div>
          </div>
          <div id="mpDaySlotsWrap" style="margin-top:16px; border-top:1px solid var(--border); padding-top:12px;">
            <div class="panel__title" style="margin-bottom:10px;">Haftalık gün / saat / personel</div>
            <div class="hint" style="margin-bottom:10px; font-size:0.9em;">
              Üye belirli bir gün artık gelemeyecekse, o günün yanındaki işareti kaldırıp <strong>Kaydet</strong>'e basın. Kaldırılan güne ait seanslar silinir, diğer günler aynı şekilde devam eder.
            </div>
            <div id="mpDaySlots" class="list"></div>
          </div>
          <div id="mpFormError" class="error hidden" style="margin-top:12px;"></div>
          <div id="mpAvailabilityError" class="error hidden" style="margin-top:8px;"></div>
        </div>
        <div class="modal__footer">
          <button id="mpEndMembershipBtn" class="btn btn--danger" type="button" style="display:none;">Üyeliği Sonlandır</button>
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="memberPackageModal">Vazgeç</button>
          <button id="mpSaveBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Paket tutarsızlığı onayı (seanslar bitti ama paket bitişi ileri tarihte) -->
    <div class="modal hidden" id="packageInconsistencyModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="packageInconsistencyModal"></div>
      <div class="modal__card" style="max-width: 480px;">
        <div class="modal__title">Paket tarihi ile seanslar uyumsuz</div>
        <div class="modal__body">
          <p id="packageInconsistencyMessage" class="hint" style="margin-bottom: 16px;"></p>
          <p class="hint" style="font-size: 0.9em;">Nasıl devam etmek istiyorsunuz?</p>
        </div>
        <div class="modal__footer">
          <button type="button" id="packageInconsistencySaveAsIsBtn" class="btn btn--primary">Bu şekilde kaydet</button>
          <button type="button" id="packageInconsistencySaveAndEndBtn" class="btn btn--secondary">Seansları kaydedip üyeliği bitmişe at</button>
          <button type="button" id="packageInconsistencyCancelBtn" class="btn btn--ghost" data-close="packageInconsistencyModal">İptal</button>
        </div>
      </div>
    </div>

    <!-- Modal: Paket Seansları (okunaklı liste + Excel/PDF dışa aktarım) -->
    <div class="modal hidden" id="packageSessionsModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="packageSessionsModal"></div>
      <div class="modal__card" style="width:min(720px, calc(100vw - 24px)); max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal__title" id="packageSessionsTitle">Paket Seansları</div>
        <div class="modal__body" style="overflow:auto; flex:1;">
          <p id="packageSessionsSubtitle" class="hint" style="margin-bottom:12px;"></p>
          <div id="packageSessionsTableWrap" style="overflow:auto;">
            <table class="table" id="packageSessionsTable" style="width:100%; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">#</th>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">Tarih</th>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">Saat</th>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">Personel</th>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">Oda</th>
                  <th style="text-align:left; padding:8px 10px; border-bottom:2px solid var(--border);">Not</th>
                </tr>
              </thead>
              <tbody id="packageSessionsTableBody"></tbody>
            </table>
          </div>
          <p id="packageSessionsEmpty" class="hint hidden" style="margin-top:12px;">Seans kaydı yok.</p>
        </div>
        <div class="modal__footer">
          <button type="button" id="packageSessionsExportExcelBtn" class="btn btn--ghost">Excel (.xlsx)</button>
          <button type="button" id="packageSessionsExportPdfBtn" class="btn btn--ghost">PDF</button>
          <div class="spacer"></div>
          <button type="button" class="btn btn--ghost" data-close="packageSessionsModal">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Seans Ekle/Düzenle -->
    <div class="modal hidden" id="sessionModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card">
        <div class="modal__title" id="sessionModalTitle">Seans</div>
        <div class="modal__body">
          <div class="formGrid">
            <div class="formRow">
              <label class="label" for="sessionDate">Tarih</label>
              <input id="sessionDate" class="input" type="date" />
            </div>
            <div class="formRow">
              <label class="label" for="sessionTime">Saat</label>
              <input id="sessionTime" class="input" type="time" />
            </div>
            <div class="formRow">
              <label class="label" for="sessionMember">Üye</label>
              <select id="sessionMember" class="input"></select>
            </div>
            <div id="sessionPackageHint" class="hint" style="margin-top:4px; margin-bottom:8px; font-size:12px;"></div>
            <div class="formRow">
              <label class="label" for="sessionStaff">Personel</label>
              <select id="sessionStaff" class="input"></select>
            </div>
            <div class="formRow">
              <label class="label" for="sessionRoom">Oda</label>
              <select id="sessionRoom" class="input"></select>
            </div>
            <div class="formRow formRow--full">
              <label class="label" for="sessionNote">Not</label>
              <input id="sessionNote" class="input" placeholder="Opsiyonel" />
            </div>
          </div>
          <div id="sessionError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <button id="deleteSessionBtn" class="btn btn--danger hidden" type="button">Sil</button>
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Vazgeç</button>
          <button id="saveSessionBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Çalışma Saatleri -->
    <div class="modal hidden" id="workingHoursModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card" style="width:min(600px, calc(100vw - 24px));">
        <div class="modal__title">Merkezin Çalışma Saatleri</div>
        <div class="modal__body">
          <div class="hint" style="margin-bottom:14px;">
            Her gün için çalışma saatlerini belirleyin. Seanslar sadece bu saatlerde eklenebilir.
          </div>
          <div id="workingHoursList" class="list"></div>
          <div id="workingHoursError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Vazgeç</button>
          <button id="saveWorkingHoursBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Paket Tanımlama -->
    <div class="modal hidden" id="packagesModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="packagesModal"></div>
      <div class="modal__card" style="width:min(900px, calc(100vw - 24px)); max-width:95vw;">
        <div class="modal__title">Paket Tanımlama</div>
        <div class="modal__body" style="display:flex; gap:24px; flex-wrap:wrap;">
          <div style="flex:1; min-width:280px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
              <span class="panel__title">Paket Tanımlama</span>
              <button id="packagesExportExcelBtn" class="btn btn--ghost btn--xs" type="button">Excel'e Aktar</button>
            </div>
            <div id="packagesListWrap" style="overflow:auto; max-height:360px;">
              <table class="packagesTable" id="packagesTable">
                <thead>
                  <tr>
                    <th>Paket Adı</th>
                    <th>Ders Adet</th>
                    <th>Ay Aşım Süresi</th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="packagesList"></tbody>
              </table>
            </div>
          </div>
          <div style="flex:0 0 280px;">
            <div class="panel__title" style="margin-bottom:12px;">Yeni Kayıt</div>
            <div class="formGrid">
              <div class="formRow formRow--full">
                <label class="label" for="packageName">Paket Adı</label>
                <input id="packageName" class="input" placeholder="Paket adı" />
              </div>
              <div class="formRow">
                <label class="label" for="packageLessonCount">Ders Adet</label>
                <input id="packageLessonCount" class="input" type="number" min="1" value="1" />
              </div>
              <div class="formRow">
                <label class="label" for="packageMonthOverrun">Ay Aşım Süresi</label>
                <input id="packageMonthOverrun" class="input" type="number" min="0" value="0" />
              </div>
              <div class="formRow formRow--full">
                <label class="label" for="packageWeeklyLessonCount">Haftalık Ders Sayısı</label>
                <input id="packageWeeklyLessonCount" class="input" type="number" min="0" placeholder="Boş bırakılabilir" />
              </div>
              <div class="formRow formRow--full">
                <label class="label" for="packageType">Paket Tipi</label>
                <select id="packageType" class="input">
                  <option value="fixed">Sabit</option>
                  <option value="flexible">Esnek</option>
                </select>
              </div>
            </div>
            <div style="margin-top:12px; display:flex; gap:8px;">
              <button id="packageSaveBtn" class="btn btn--primary" type="button">Kaydet</button>
              <button id="packageCancelBtn" class="btn btn--ghost" type="button">İptal</button>
            </div>
            <div id="packagesFormError" class="error hidden" style="margin-top:8px;"></div>
          </div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="packagesModal">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: İşlem Logları -->
    <div class="modal hidden" id="activityLogsModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="activityLogsModal"></div>
      <div class="modal__card" style="width:min(960px, calc(100vw - 24px)); max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal__title">İşlem Logları</div>
        <div class="modal__body" style="overflow:auto; flex:1;">
          <div class="hint" style="margin-bottom:12px;">
            Kim, ne işlemi, ne zaman yaptı. Sadece admin/manager görebilir.
          </div>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:12px;">
            <select id="activityLogsActionFilter" class="input" style="width:180px;">
              <option value="">Tüm işlemler</option>
              <option value="auth.login">Giriş</option>
              <option value="auth.login_failed">Giriş başarısız</option>
              <option value="member.create">Üye ekleme</option>
              <option value="member.update">Üye güncelleme</option>
              <option value="member.delete">Üye silme</option>
              <option value="session.create">Seans ekleme</option>
              <option value="session.update">Seans güncelleme</option>
              <option value="session.delete">Seans silme</option>
              <option value="room.create">Oda ekleme</option>
              <option value="room.update">Oda güncelleme</option>
              <option value="room.delete">Oda silme</option>
              <option value="staff.create">Personel ekleme</option>
              <option value="staff.update">Personel güncelleme</option>
              <option value="staff.delete">Personel silme</option>
              <option value="package.create">Paket ekleme</option>
              <option value="package.update">Paket güncelleme</option>
              <option value="package.delete">Paket silme</option>
              <option value="member_package.create">Üye paketi ekleme</option>
              <option value="member_package.update">Üye paketi güncelleme</option>
              <option value="member_package.end">Üye paketi sonlandırma</option>
              <option value="settings.working_hours_update">Çalışma saatleri</option>
            </select>
            <label class="label" style="display:flex; align-items:center; gap:4px;">Başlangıç <input id="activityLogsFrom" class="input" type="date" style="width:140px;" /></label>
            <label class="label" style="display:flex; align-items:center; gap:4px;">Bitiş <input id="activityLogsTo" class="input" type="date" style="width:140px;" /></label>
            <button id="activityLogsApplyFilterBtn" class="btn btn--ghost" type="button">Filtrele</button>
          </div>
          <div id="activityLogsError" class="error hidden"></div>
          <div style="overflow:auto; max-height:50vh;">
            <table class="packagesTable" style="width:100%;">
              <thead>
                <tr>
                  <th>Tarih / Saat</th>
                  <th>Kim</th>
                  <th>İşlem</th>
                  <th>Varlık</th>
                  <th>Detay</th>
                </tr>
              </thead>
              <tbody id="activityLogsTableBody"></tbody>
            </table>
          </div>
          <div id="activityLogsPagination" style="margin-top:12px; display:flex; align-items:center; gap:12px; flex-wrap:wrap;"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="activityLogsModal">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Odalar / Alet -->
    <div class="modal hidden" id="roomsModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card" style="width:min(600px, calc(100vw - 24px));">
        <div class="modal__title">Odalar / Alet</div>
        <div class="modal__body">
          <div class="hint" style="margin-bottom:14px;">
            Aynı saatte aynı odada seans sayısı, o odanın <b>alet</b> sayısını geçemez.
          </div>
          <div id="roomsList" class="list"></div>
          <div class="inlineAdd" style="margin-top:12px;">
            <input id="newRoomName" class="input" placeholder="Oda adı" />
            <input id="newRoomDevices" class="input" type="number" min="1" step="1" value="1" placeholder="Alet sayısı" style="width:120px;" />
            <button id="addRoomBtn" class="btn btn--ghost" type="button">Ekle</button>
          </div>
          <div id="roomsError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Personel -->
    <div class="modal hidden" id="staffModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card" style="width:min(900px, calc(100vw - 24px));">
        <div class="modal__title">Personel Yönetimi</div>
        <div class="modal__body">
          <div id="staffList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; margin-bottom:16px;"></div>
          <div style="border-top:1px solid var(--border); padding-top:16px;">
            <div class="panel__title" style="margin-bottom:12px;">Yeni Personel Ekle</div>
            <div class="formGrid">
              <div class="formRow">
                <label class="label" for="newStaffFirstName">Ad</label>
                <input id="newStaffFirstName" class="input" placeholder="Ad" />
              </div>
              <div class="formRow">
                <label class="label" for="newStaffLastName">Soyad</label>
                <input id="newStaffLastName" class="input" placeholder="Soyad" />
              </div>
              <div class="formRow">
                <label class="label" for="newStaffPhone">Telefon</label>
                <input id="newStaffPhone" class="input" type="tel" placeholder="(xxx)xxx-xx-xx" maxlength="14" inputmode="numeric" autocomplete="tel" />
              </div>
            </div>
            <button id="addStaffBtn" class="btn btn--primary" type="button" style="margin-top:12px;">Personel Ekle</button>
          </div>
          <div id="staffError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Personel Kartı Düzenle -->
    <div class="modal hidden" id="staffCardModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card" style="width:min(700px, calc(100vw - 24px));">
        <div class="modal__title" id="staffCardTitle">Personel Kartı</div>
        <div class="modal__body">
          <div class="formGrid">
            <div class="formRow">
              <label class="label" for="editStaffFirstName">Ad</label>
              <input id="editStaffFirstName" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="editStaffLastName">Soyad</label>
              <input id="editStaffLastName" class="input" />
            </div>
            <div class="formRow">
              <label class="label" for="editStaffPhone">Telefon</label>
              <input id="editStaffPhone" class="input" type="tel" placeholder="(xxx)xxx-xx-xx" maxlength="14" inputmode="numeric" autocomplete="tel" />
            </div>
          </div>
          <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:16px;">
            <div class="panel__title" style="margin-bottom:12px;">Çalışma Saatleri (Haftalık)</div>
            <div id="staffCardWorkingHours" class="list"></div>
          </div>
          <div id="staffCardError" class="error hidden"></div>
        </div>
        <div class="modal__footer">
          <button id="deleteStaffCardBtn" class="btn btn--danger" type="button">Sil</button>
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Vazgeç</button>
          <button id="saveStaffCardBtn" class="btn btn--primary" type="button">Kaydet</button>
        </div>
      </div>
    </div>

    <!-- Modal: Görev Dağıtımı -->
    <div class="modal hidden" id="taskDistributionModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="1"></div>
      <div class="modal__card" style="width:min(900px, calc(100vw - 24px));">
        <div class="modal__title">Görev Dağıtımı – Tüm Odalar Dolu</div>
        <div class="modal__body">
          <div class="hint" style="margin-bottom:14px;">
            Her odada en fazla 1 personel çalışabildiği için, merkezdeki oda sayısı kadar personelin aynı anda olduğu saatleri ve seans dağılımını görüntüleyin.
          </div>
          <div id="taskDistributionContent"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="1">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Üyeleri Listele (aktif paketi olan üyeler) -->
    <div class="modal hidden" id="listMembersModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="listMembersModal"></div>
      <div class="modal__card" style="width:min(1280px, calc(100vw - 24px)); max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal__title">Üyeleri Listele – Aktif Üyeler</div>
        <div class="modal__body" style="overflow-y:auto; flex:1;">
          <div class="hint" style="margin-bottom:14px;">
            Sadece aktif paketi olan üyeler listelenir. Satıra tıklayarak aktif paket seanslarını görebilir; Kimlik Kartı, Paket ve Sil işlemlerini butonlardan yapabilirsiniz.
          </div>
          <div class="formRow" style="margin-bottom:14px;">
            <label class="label" for="listMembersFilter">Filtre</label>
            <input id="listMembersFilter" class="input" type="text" placeholder="Ad, soyad veya telefon numarasına göre ara..." style="max-width:320px;" />
          </div>
          <div id="listMembersContent"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="listMembersModal">Kapat</button>
        </div>
      </div>
    </div>

    <!-- Modal: Üyeliği Bitmiş Üyeler (paket ve seans listesi) -->
    <div class="modal hidden" id="expiredMembershipsModal" role="dialog" aria-modal="true">
      <div class="modal__backdrop" data-close="expiredMembershipsModal"></div>
      <div class="modal__card" style="width:min(1100px, calc(100vw - 24px)); max-height:90vh; display:flex; flex-direction:column;">
        <div class="modal__title">Üyeliği Bitmiş Üyeler – Paket ve Seanslar</div>
        <div class="modal__body" style="overflow-y:auto; flex:1;">
          <div class="hint" style="margin-bottom:14px;">
            Bitiş tarihi geçmiş üyelik paketleri ve bu paketlerdeki seanslar ayrı listelenir.
          </div>
          <div class="formRow" style="margin-bottom:14px;">
            <label class="label" for="expiredMembershipsFilter">Filtre</label>
            <input id="expiredMembershipsFilter" class="input" type="text" placeholder="Ad, soyad veya telefon numarasına göre ara..." style="max-width:320px;" />
          </div>
          <div id="expiredMembershipsContent"></div>
        </div>
        <div class="modal__footer">
          <div class="spacer"></div>
          <button class="btn btn--ghost" type="button" data-close="expiredMembershipsModal">Kapat</button>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="./api.js"></script>
    <script src="./app.js"></script>
  </body>
</html>

